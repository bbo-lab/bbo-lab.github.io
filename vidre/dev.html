<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.10.0"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>VidRe: Development</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="clipboard.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  extensions: ["tex2jax.js"],
  jax: ["input/TeX","output/HTML-CSS"],
});
</script>
<script type="text/javascript" async="async" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="doxygen-awesome.css" rel="stylesheet" type="text/css"/>
<link href="doxygen-awesome-sidebar-only.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectlogo"><img alt="Logo" src="vidre.svg"/></td>
  <td id="projectalign">
   <div id="projectname">VidRe<span id="projectnumber">&#160;.</span>
   </div>
   <div id="projectbrief">Video recording software for scientific purposes.</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.10.0 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function(){initNavTree('dev.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Development</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1><a class="anchor" id="dev-objective"></a>
Objective</h1>
<p>The objective is to create a videography software suite, that allows to record scientifically relevant data from different types of video sources including supplemental information and data streams (such as timing, audio, etc.). Ultimately we aim at a modular framework that allows to supplement real-time features, such as object recognition combined with feedback.</p>
<h1><a class="anchor" id="dev-design"></a>
Design</h1>
<p>To facilitate remote data acquisition, which may happen on a headless system, recording and displaying data are separated into a backend (the recording service or daemon, respectively) and the frontend (the user interface). The following diagram gives an idea of the components and the acquisition data flow:</p>
<div class="image">
<object type="image/svg+xml" data="overview.svg" style="pointer-events: none;"></object>
</div>
<h2><a class="anchor" id="dev-backend"></a>
Backend</h2>
<p>The backend must—with high reliability and speed—record video frames and additional data from various sources. It should be implemented in the sense of a system service (which also means, it should automatically start on system boot). The service must not crash on partial failures (such as device errors) but continue to operate.</p>
<p><span style="color: orange"><b>TBD</b>: Worst-case: error recovery.</span></p>
<p><span style="color: orange">BBO had some issues with DevWareX software. The software records in MP4 format. The exact details are unknown, but it seems, that MP4 files can only be read when meta-information is written at the end of the recording. This was missing in some cases and recovery is only possible if the meta-information is known. Therefore, we suggest, that all necessary information, that is required to recover data, is written immediately, and, when the service starts again, will "fix" the situation. </span></p>
<h3><a class="anchor" id="dev-backend-monitoring"></a>
Monitoring</h3>
<p>Monitoring refers to several aspects. One major aspect is hard-disk space and health which must be reported to the user interface regularly. For a remote system there are more things to consider, for example temperature or battery status, etc.</p>
<p><b>Requires</b>:<br  />
 <a class="el" href="#core-logging">Logging</a><br  />
 <a class="el" href="#core-sysinfo">System information</a><br  />
</p>
<h3><a class="anchor" id="dev-backend-devices"></a>
Devices</h3>
<p>The major devices, that must be respresented initially are Basler USB3Vision products (via <a href="https://www.baslerweb.com/de-de/software/pylon/">pylon Software</a>) and OnSemi/Aptina Demo3 (via <a href="https://aptina.atlassian.net/wiki/spaces/DEVS/pages/3244099/DevWareX">DevWareX</a>). Additionally, it appears favorable, also to support standard UVC cameras.</p>
<p>Future development, might however, also require additional data, such as GNSS coordinates.</p>
<p><span style="color: orange"><b>TBD</b>: The first plugin to develop is a dummy video device which should serve as basis for benchmarking.</span></p>
<p><b>Requires</b>:<br  />
 <a class="el" href="#core-plugins">Plugins</a><br  />
 <a class="el" href="#core-storage">Storage</a><br  />
 <a class="el" href="#core-settings">Settings</a><br  />
</p>
<h3><a class="anchor" id="dev-backend-storage"></a>
Storage</h3>
<p>Storage, here, refers both to how data is stored on the hard-disk as well as how data is provisioned for transmission as well as real-time analysis. Additionally, plugins may provide video compression or data formats (such as HDF5). <span style="color: orange"><b>TBD</b>: Encoding (lossy or lossless) may happen after data is recorded in a raw format.</span></p>
<p><b>Requires</b>:<br  />
 <a class="el" href="#core-storage">Storage</a><br  />
 <a class="el" href="#core-plugins">Plugins</a><br  />
</p>
<h3><a class="anchor" id="dev-backend-realtime"></a>
Real-time interface</h3>
<p><span style="color: orange"><b>TBD</b>: The "real-time interface" will probably only require storage access. Implementation-wise we need to think if such access to the data must be granted also to external programs.</span></p>
<h3><a class="anchor" id="dev-backend-transport"></a>
Transport</h3>
<p>Data transmission from the backend to the frontend (over network or locally) must provide different channels. The "high priority" channel used for recording and possibly real-time analysis is part of <a class="el" href="#core-storage">Storage</a>. Second, a "control channel" is needed, that does not allow packet loss. Third, a "data channel" must be provided, which can be lossy (i.e. while no recorded image must be lost when writing to disk, not every image has to be displayed in the user-interface).</p>
<p><b>Requires</b>:<br  />
 <a class="el" href="#core-transport">Transport</a><br  />
</p>
<h3><a class="anchor" id="dev-backend-settings"></a>
Settings</h3>
<p>"Settings" encompasses how program-wide settings are stored in a configuration file as well as how settings are applied, for example to plugins.</p>
<p><b>Requires</b>:<br  />
 <a class="el" href="#core-settings">Settings</a><br  />
</p>
<h2><a class="anchor" id="dev-frontend"></a>
Frontend</h2>
<p><span style="color: orange"><b>TBD</b>: A good starting point for designing a user interface is Basler's <a href="https://docs.baslerweb.com/overview-of-the-pylon-viewer">pylon Viewer</a>.</span></p>
<p><span style="color: orange"> What has to be kept in mind:</p><ul>
<li>display of multiple cameras</li>
<li>triggered, non-trigger mode (→ "arm" and "start" button)</li>
<li>image enhancement</li>
<li>overlays (such as the cross-hair above)</li>
<li>adjustment aids (such as contrast display)</li>
<li>maybe overlays (such as histograms)</li>
<li>multi-objective cameras (→ splitting)</li>
<li>rotation/mirroring</li>
<li>display of other data streams (e.g. audio) etc. </li>
</ul>
<p></span></p>
<p><span style="color: orange"></span></p>
<h1><a class="anchor" id="dev-milestone"></a>
Milestones</h1>
<p><span style="color: orange"></span></p>
<p><span style="color: orange"></span></p>
<h3><a class="anchor" id="milestone-0"></a>
Zero</h3>
<p><span style="color: orange"></span></p>
<p><span style="color: orange">The first implementation should implement <a class="el" href="#core-storage">Storage</a>, specifically named shared memory and a semaphore with <a class="el" href="#core-plugins">Plugins</a> with a Basler® camera plus a simple demo GUI displaying the images also using shared memory and the semaphore.</span></p>
<p><span style="color: orange"></span></p>
<h1><a class="anchor" id="dev-code"></a>
Coding</h1>
<p><span style="color: orange"></span></p>
<p><span style="color: orange"></span></p>
<h2><a class="anchor" id="dev-lang"></a>
Language(s) and configuration</h2>
<p><span style="color: orange"></span></p>
<p><span style="color: orange">Core functionality should be provided in C++ (at least <a href="https://en.cppreference.com/w/cpp/20">C++20</a>). Note, however, that the software must be compilable on at least Linux® and Windows®. For user-interface applications <a href="https://www.qt.io/product/framework">Qt6</a> forms the basis.</span></p>
<p><span style="color: orange">A clang-format file is provided.</span></p>
<p><span style="color: orange">While the backend (the recording service or daemon, respectively) will rely on compiled code, interfaces to other languages (mainly Python, but also Matlab and more) will be provided. The frontend (user interface), though, could be a mixture of Python and C++ (see <a href="https://doc.qt.io/qtforpython-6/">Qt for Python</a>). <span style="color: orange"><b>TBD</b>: With respect to the backend, it should be discussed if a terminal UI should be provided to simplify configuration or supervision, especially on a headless, remote machine.</span></span></p>
<p><span style="color: orange">For project configuration we use <a href="https://cmake.org/cmake/help/latest/">CMake</a>.</span></p>
<p><span style="color: orange"></span></p>
<h2><a class="anchor" id="dev-git"></a>
Version control</h2>
<p><span style="color: orange"></span></p>
<p><span style="color: orange">The "main" branch remains in the hands of BBO authors. External developers may not without explicit permission commit there. Instead, they must either use an arranged (read "agreed upon") branch or use github's pull-request feature.</span></p>
<p><span style="color: orange"><span style="color: orange"><b>TBD</b>: make user-interface independent (see vidre-gui on github)?</span></span></p>
<p><span style="color: orange"></span></p>
<h2><a class="anchor" id="dev-docs"></a>
Documentation</h2>
<p><span style="color: orange"></span></p>
<p><span style="color: orange">API documentation is generated using <a href="https://doxygen.nl/manual/index.html">Doxygen</a> and published regularly on <a href="https://bbo-lab.github.io/vidre">https://bbo-lab.github.io/vidre</a>. The <br  />
 <a class="el" href="group__api-core-util-uuid.html">UUID</a> documentation should serve as a reference for how to document source code.</span></p>
<p><span style="color: orange">Documentation is, however, not limited to the source code. <span style="color: orange"><b>TBD</b>: Run-time documentation and help files are just as well required.</span></span></p>
<p><span style="color: orange">Document as much as necessary, but not more (in case of doubt, follow <a href="https://xkcd.com/1343/">XKCD 1343</a> but not <a href="https://xkcd.com/1481/">XKCD 1481</a>).</span></p>
<p><span style="color: orange"></span></p>
<h1><a class="anchor" id="dev-impl"></a>
Implementation</h1>
<p><span style="color: orange"></span></p>
<p><span style="color: orange"></span></p>
<h2><a class="anchor" id="dev-core"></a>
Core library</h2>
<p><span style="color: orange"></span></p>
<p><span style="color: orange"></span></p>
<h3><a class="anchor" id="core-exception"></a>
Error handling</h3>
<p><span style="color: orange"></span></p>
<p><span style="color: orange">Error handling, depending on context, uses either standard error codes (e.g. <a href="https://en.cppreference.com/w/cpp/error/errc">''std::errc''</a>) or exceptions. See <a class="el" href="group__api-core-exception.html">Errors and exceptions</a> for further information.</span></p>
<p><span style="color: orange"></span></p>
<h3><a class="anchor" id="core-logging"></a>
Logging</h3>
<p><span style="color: orange"></span></p>
<p><span style="color: orange"><span style="color: orange"><b>TBD</b>: Logging must differentiate between priority messages, which must be transmitted to the user-interface and rather local logging, which may include debug information. The format should be decided after message passing has implemented.</span></span></p>
<p><span style="color: orange"></span></p>
<h3><a class="anchor" id="core-format"></a>
Data format</h3>
<p><span style="color: orange"></span></p>
<p><span style="color: orange">For in-memory data, both acquisition (e.g. video frames) and meta-data (e.g. video format and dimensions), as well as data transmission, we suggest <a href="https://en.wikipedia.org/wiki/Type%E2%80%93length%E2%80%93value">TLV</a> encoding (see also <a href="https://en.wikipedia.org/wiki/X.690#DER_encoding">DER</a>). Note, however, that endianess must be taken into account (and be present in all files, akin to the byte-order-mark in Unicode).</span></p>
<p><span style="color: orange"><span style="color: orange"><b>TBD</b>: A video frame, for example, could be implemented in the following way (indentation is used for the values): </p><pre class="fragment">&lt;T:META&gt;&lt;L&gt;&lt;V:
    &lt;T:FRAME_ID&gt;&lt;L&gt;&lt;V:frame index&gt;
    &lt;T:FRAME_TS&gt;&lt;L&gt;&lt;V:frame timestamp&gt;
    ... the initial meta data must also contain format, encoding, etc. ...
&gt;
&lt;T:FRAME&gt;&lt;L&gt;&lt;V:DATA&gt;
</pre><p> This can, of course, be extended to any data format, e.g. chunks of audio.</span></span></p>
<p><span style="color: orange"></span></p>
<h3><a class="anchor" id="core-storage"></a>
Storage</h3>
<p><span style="color: orange"></span></p>
<p><span style="color: orange">Storage, here, encompasses both, memory and disk storage.</span></p>
<p><span style="color: orange"></p><dl class="section user"><dt>Memory</dt><dd>For reasons of speed and to facilitate options for real-time analysis, memory should be implemented as a ring buffer using shared memory. The shared memory should be named (thus it can be shared also to other processes and not only loadable modules).</dd></dl>
<p>Each data-generating device (plugin) reserves it's own ring buffer and solely writes to it. A named semaphore can then be used to inform other threads and processes to inform about the new data chunk.</span></p>
<p><span style="color: orange"></p><dl class="section user"><dt>Disk</dt><dd>Disk storage should be provided through plugins. The initial implementation will only require raw storage, future options may use lossy or lossles compression, or, even only store a video frame partially.</dd></dl>
<p><span style="color: orange"><b>TBD</b>: Alternatively, data could also be transformed post-hoc in formats, such as HDF5.</span></span></p>
<p><span style="color: orange"><span style="color: orange"><b>TBD</b>: Storing frames partially, for example selected using object tracking, would raise the question of filtering prior to raw data storage. The API should at least provide a way to create multiple data streams that can be configured apropriately. Then the "disk writer" process or thread must be informed no to use the "high priority" shared memory from the device but from the filter. </span></span></p>
<p><span style="color: orange"></span></p>
<h3><a class="anchor" id="core-plugins"></a>
Plugins</h3>
<p><span style="color: orange"></span></p>
<p><span style="color: orange">Plugins may come as loadable modules or external programs. <span style="color: orange"><b>TBD</b>: They are organized hierarchically: </p><pre class="fragment">device
    video
        pylon
        onsemi
storage
    raw
...
</pre><p> </span></span></p>
<p><span style="color: orange">Each plugin is accompanied by a configuration file, together with documentation. <span style="color: orange"><b>TBD</b>: It must be distinguished between information about the plugin itself, as well as configuration options that can be passed to it. It seems sensible to also encode user-interface layout for a "settings page". See e.g. USB3Vision, GenICam, etc.</span>. See also <a class="el" href="#core-settings">Settings</a> below.</span></p>
<p><span style="color: orange"></span></p>
<h3><a class="anchor" id="core-sysinfo"></a>
System information</h3>
<p><span style="color: orange"></span></p>
<p><span style="color: orange"><span style="color: orange"><b>TBD</b>: The format of how to provide system information, such as harddisk space and health, as well as other information, such as CPU temperature or the like, is complex. This information has to be passed between back- and frontend independent of the mode of communication.</span></span></p>
<p><span style="color: orange"></p><dl class="section see"><dt>See also</dt><dd><a class="el" href="#core-transport">Transport</a></dd></dl>
<p></span></p>
<h3><a class="anchor" id="core-transport"></a>
Transport</h3>
<p><span style="color: orange"></span></p>
<p><span style="color: orange">As mentioned above, there are three modes of data transmission. The high-priority, or raw data, respectively stream is covered by the storage/memory handler. Therefore, two more tranmission modes, that also need to be "networkable" need to be integrated. Note that networking is a feature that will be supplemented in the longer run, the API only needs to be prepared for such an extension.</span></p>
<p><span style="color: orange"></p><dl class="section user"><dt>Control</dt><dd>The control channel should be a named pipe for local transmission and TCP for a networked connection.</dd></dl>
<dl class="section user"><dt>Data</dt><dd>The local data channel my use the shared ring buffer (and the semaphore) describe above (see <a class="el" href="#core-storage">Storage</a>) directly. For a network connection UDP is sufficient.</dd></dl>
<dl class="section see"><dt>See also</dt><dd><a class="el" href="#core-format">Data format</a></dd></dl>
<p></span></p>
<h3><a class="anchor" id="core-settings"></a>
Settings</h3>
<p><span style="color: orange"></span></p>
<p><span style="color: orange">As core configuration and settings format, VidRe will use JSON. This can also be similarly represented in C++ using initializer lists. We propose a class, e.g. </p><div class="fragment"><div class="line"><span class="keyword">class </span>options {</div>
<div class="line">    <span class="keyword">class </span>entry; <span class="comment">// basically a variant, that can hold maps, arrays and values</span></div>
<div class="line"> </div>
<div class="line">    options(<span class="keyword">const</span> std::string &amp;json);</div>
<div class="line">    options(<span class="keyword">const</span> std::initializer_list&lt;entry&gt; &amp;table);</div>
<div class="line">};</div>
</div><!-- fragment --><p> which would allow to write </p><div class="fragment"><div class="line">plugin[<span class="stringliteral">&quot;device/video/uvc&quot;</span>].setup({ </div>
<div class="line">    { <span class="stringliteral">&quot;fps&quot;</span>, 20 }, </div>
<div class="line">    { <span class="stringliteral">&quot;geometry&quot;</span>, {</div>
<div class="line">        {<span class="stringliteral">&quot;x&quot;</span>, 0}, </div>
<div class="line">        {<span class="stringliteral">&quot;y&quot;</span>, 0}, </div>
<div class="line">        {<span class="stringliteral">&quot;width&quot;</span>, 320},</div>
<div class="line">        {<span class="stringliteral">&quot;height&quot;</span>, 200}</div>
<div class="line">    }}</div>
<div class="line">});</div>
</div><!-- fragment --><p> instead of </p><div class="fragment"><div class="line">plugin[<span class="stringliteral">&quot;device/video/uvc&quot;</span>].setup(<span class="stringliteral">&quot;{ \&quot;fps\&quot;: 20, … }&quot;</span>);</div>
</div><!-- fragment --><p> </span></p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.10.0 </li>
  </ul>
</div>
</body>
</html>
